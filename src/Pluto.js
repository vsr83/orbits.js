// This implementation follows Chapter 37 of 
// J. Meeus - Astronomical Algorithms.

import { coordEclEq } from "./Frames.js";
import { sind, cosd, vecDiff, vecMul } from "./MathUtils.js";
import { vsop87 } from "./Vsop87A.js";

// Table 37.A
const plutoPeriodicTerms = [
//    J  S  P       Lon_A     Lon_B     Lat_A      Lat_B     Rad_A     Rad_B
    [ 0, 0, 1,  -19799805, 19850055, -5452852, -14974862, 66865439, 68951812],
    [ 0, 0, 2,     897144, -4954829,  3527812,   1672790,-11827535,  -332538],
    [ 0, 0, 3,     611149,  1211027, -1050748,    327647,  1593179, -1438890],
    [ 0, 0, 4,    -341243,  -189585,   178690,   -292153,   -18444,   483220],
    [ 0, 0, 5,     129287,   -34992,    18650,    100340,   -65977,   -85431],
    [ 0, 0, 6,     -38164,    30893,   -30697,    -25823,    31174,    -6032],
    [ 0, 1,-1,      20442,    -9987,     4878,     11248,    -5794,    22161],
    [ 0, 1, 0,      -4063,    -5071,      226,       -64,     4601,     4032],
    [ 0, 1, 1,      -6016,    -3336,     2030,      -836,    -1729,      234],
    [ 0, 1, 2,      -3956,     3039,       69,      -604,     -415,      702],
    [ 0, 1, 3,       -667,     3572,     -247,      -567,      239,      723],
    [ 0, 2,-2,       1276,      501,      -57,         1,       67,      -67],
    [ 0, 2,-1,       1152,     -917,     -122,       175,     1034,     -451],
    [ 0, 2, 0,        630,    -1277,      -49,      -164,     -129,      504],
    [ 1,-1, 0,       2571,     -459,     -197,       199,      480,     -231],
    [ 1,-1, 1,        899,    -1449,      -25,       217,        2,     -441],
    [ 1, 0,-3,      -1016,     1043,      589,      -248,    -3359,      265],
    [ 1, 0,-2,      -2343,    -1012,     -269,       711,     7856,    -7832],
    [ 1, 0,-1,       7042,      788,      185,       193,       36,    45763],
    [ 1, 0, 0,       1199,     -338,      315,       807,     8663,     8547],
    [ 1, 0, 1,        418,      -67,     -130,       -43,     -809,     -769],
    [ 1, 0, 2,        120,     -274,        5,         3,      263,     -144],
    [ 1, 0, 3,        -60,     -159,        2,        17,     -126,       32],
    [ 1, 0, 4,        -82,      -29,        2,         5,      -35,      -16],
    [ 1, 1,-3,        -36,      -29,        2,         3,      -19,       -4],
    [ 1, 1,-2,        -40,        7,        3,         1,      -15,        8],
    [ 1, 1,-1,        -14,       22,        2,        -1,       -4,       12],
    [ 1, 1, 0,          4,       13,        1,        -1,        5,        6],
    [ 1, 1, 1,          5,        2,        0,        -1,        3,        1],
    [ 1, 1, 3,         -1,        0,        0,         0,        6,       -2],
    [ 2, 0,-6,          2,        0,        0,        -2,        2,        2],
    [ 2, 0,-5,         -4,        5,        2,         2,       -2,       -2],
    [ 2, 0,-4,          4,       -7,       -7,         0,       14,       13],
    [ 2, 0,-3,         14,       24,       10,        -8,      -63,       13],
    [ 2, 0,-2,        -49,      -34,       -3,        20,      136,     -236],
    [ 2, 0,-1,        163,      -48,        6,         5,      273,     1065],
    [ 2, 0, 0,          9,      -24,       14,        17,      251,      149],
    [ 2, 0, 1,         -4,        1,       -2,         0,      -25,       -9],
    [ 2, 0, 2,         -3,        1,        0,         0,        9,       -2],
    [ 2, 0, 3,          1,        3,        0,         0,       -8,        7],
    [ 3, 0,-2,         -3,       -1,        0,         1,        2,      -10],
    [ 3, 0,-1,          5,       -3,        0,         0,       19,       35],
    [ 3, 0, 0,          0,        0,        1,         0,       10,        3]
];

const numTerms = plutoPeriodicTerms.length;

/**
 * Compute position of Pluto.
 * 
 * @param {*} JT 
 *      Julian time (TDB).
 * 
 * @returns Position in meters in the ecliptic heliocentric frame.
 */
export function plutoPositionEclHel(JT)
{
    const T = (JT - 2451545.0) / 36525.0;

    const J = 34.35 + 3034.9057 * T;
    const S = 50.08 + 1222.1138 * T;
    const P = 238.96 + 144.9600 * T;

    let rad =  40.7241346;
    let lon = 238.958116 + 144.96 * T;
    let lat =  -3.908239;

    for (let indTerm = 0; indTerm < numTerms; indTerm++)
    {
        let [i, j, k, lonA, lonB, latA, latB, radA, radB] = plutoPeriodicTerms[indTerm];

        const alpha = i*J + j*S + k*P;
        lon += lonA * sind(alpha) + lonB * cosd(alpha);
        lat += latA * sind(alpha) + latB * cosd(alpha);
        rad += radA * sind(alpha) + radB * cosd(alpha);
    }

    lon *= 1e-6;
    lat *= 1e-6;
    rad *= 1e-7;
    rad += 40.7241346;
    lon += 238.958116 + 144.96 * T;
    lat += -3.908239;

    const au = 1.495978707e11;
    const distance = rad * au;
    const rEclHel = [distance * cosd(lon) * cosd(lat),
                     distance * sind(lon) * cosd(lat),
                     distance * sind(lat)];

    return rEclHel;
}
